<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户登录</title>
    <!-- 1. 引入 Element UI 样式 (国内镜像) -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.14/theme-chalk/index.css">

    <!-- 2. 本地vue -->
    <script src="Scripts/vue.min.js"></script>

    <!-- 3. 引入 Element UI 组件库 (国内镜像) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.14/index.js"></script>

    <!-- 4. 引入 Axios (国内镜像) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .login-form {
            width: 400px;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #409EFF;
            font-size: 24px;
            font-weight: bold;
        }

        .captcha-container {
            display: flex;
            align-items: center;
        }

        .captcha-image {
            margin-left: 10px;
            cursor: pointer;
            border: 1px solid #DCDFE6;
            border-radius: 4px;
            height: 40px;
        }

        .login-btn {
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="login-container">
            <div class="login-form">
                <div class="login-title">用户登录</div>
                <el-form :model="loginForm" :rules="rules" ref="loginForm" label-width="80px">
                    <el-form-item label="用户名" prop="userId">
                        <el-input v-model="loginForm.userId" placeholder="请输入用户名"></el-input>
                    </el-form-item>
                    <el-form-item label="密码" prop="password">
                        <el-input type="password" v-model="loginForm.password" placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <el-form-item label="验证码" prop="captcha">
                        <div class="captcha-container">
                            <el-input v-model="loginForm.captcha" placeholder="请输入验证码" style="flex: 1;"></el-input>
                            <img :src="captchaImage" @click="refreshCaptcha" class="captcha-image" alt="验证码" title="点击刷新验证码">
                        </div>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" class="login-btn" @click="handleLogin" :loading="loading">登录</el-button>
                        <div style="text-align: right;">
                            <el-link type="info" @click="regDialogVisible = true" style="font-size: 13px;">没有账号？立即注册</el-link>
                        </div>
                    </el-form-item>
                    <!-- 注册弹窗 -->
                    <el-dialog title="新用户注册" :visible.sync="regDialogVisible" width="400px">
                        <el-form :model="regForm" :rules="regRules" ref="regForm" label-width="80px">
                            <el-form-item label="用户名" prop="userId">
                                <el-input v-model="regForm.userId" placeholder="请输入用户名"></el-input>
                            </el-form-item>
                            <el-form-item label="密码" prop="password">
                                <el-input type="password" v-model="regForm.password" placeholder="请输入密码"></el-input>
                            </el-form-item>
                            <el-form-item label="确认密码" prop="rePassword">
                                <el-input type="password" v-model="regForm.rePassword" placeholder="请再次输入密码"></el-input>
                            </el-form-item>
                        </el-form>
                        <div slot="footer">
                            <el-button @click="regDialogVisible = false">取消</el-button>
                            <el-button type="primary" @click="handleRegister" :loading="regLoading">确认注册</el-button>
                        </div>
                    </el-dialog>
                </el-form>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                // 自定义校验：检查两次密码是否一致
                const validatePass2 = (rule, value, callback) => {
                    if (value === '') {
                        callback(new Error('请再次输入密码'));
                    } else if (value !== this.regForm.password) {
                        callback(new Error('两次输入密码不一致!'));
                    } else {
                        callback();
                    }
                };

                return {
                    // --- 登录相关 ---
                    loginForm: {
                        userId: '',
                        password: '',
                        captcha: ''
                    },
                    rules: {
                        userId: [{ required: true, message: '请输入用户名', trigger: 'blur' }],
                        password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
                        captcha: [{ required: true, message: '请输入验证码', trigger: 'blur' }]
                    },
                    loading: false,

                    // --- 注册相关  ---
                    regDialogVisible: false, // 控制注册弹窗显示
                    regLoading: false,      // 注册按钮加载状态
                    regForm: {
                        userId: '',
                        password: '',
                        confirmPassword: ''
                    },
                    regRules: {
                        userId: [{ required: true, message: '请输入用户名', trigger: 'blur' }],
                        password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
                        confirmPassword: [{ validator: validatePass2, trigger: 'blur', required: true }]
                    },
                    captchaImage: '',
                    isCheckingLogin: false
                }
            },
            mounted() {
                this.refreshCaptcha();
                setTimeout(() => {
                    this.checkLoginStatus();
                }, 100);
            },
            methods: {
                // 刷新验证码
                refreshCaptcha() {
                    axios.get('/api/Account/Captcha', { params: { t: new Date().getTime() } })
                        .then(response => {
                            if (response.data && response.data.imageData) {
                                this.captchaImage = 'data:image/jpeg;base64,' + response.data.imageData;
                            } else {
                                this.$message.error('获取验证码失败');
                            }
                        })
                        .catch(error => {
                            this.$message.error('获取验证码失败');
                        });
                },
                // 处理登录
                handleLogin() {
                    this.$refs.loginForm.validate((valid) => {
                        if (valid) {
                            this.loading = true;
                            axios.post('/api/Account/Login', this.loginForm)
                                .then(response => {
                                    this.loading = false;
                                    this.$message.success('登录成功');
                                    window.location.href = 'HtmlPage1.html';
                                })
                                .catch(error => {
                                    this.loading = false;
                                    const errorMsg = error.response?.data?.Message || error.message || '登录失败';
                                    this.$message.error(errorMsg);
                                    this.refreshCaptcha();
                                });
                        }
                    });
                },
                // 处理注册 (新增)
                handleRegister() {
                    this.$refs.regForm.validate((valid) => {
                        if (valid) {
                            this.regLoading = true;
                            // 注意：这里发送明文密码，由后端接口进行 MD5 加密后存入数据库
                            axios.post('/api/Account/Register', {
                                userId: this.regForm.userId,
                                password: this.regForm.password
                            })
                                .then(response => {
                                    this.regLoading = false;
                                    this.$message.success('注册成功！请登录');
                                    this.regDialogVisible = false; // 关闭弹窗
                                    this.loginForm.userId = this.regForm.userId; // 自动填充登录框
                                    // 清空注册表单
                                    this.$refs.regForm.resetFields();
                                })
                                .catch(error => {
                                    this.regLoading = false;
                                    const errorMsg = error.response?.data?.Message || '注册失败111';
                                    this.$message.error(errorMsg);
                                });
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
